# Firmware for Relayduino ESP32

unfinished proof of concept

## How to start
- clone this repo
- download mos tool (https://mongoose-os.com/docs/mongoose-os/quickstart/setup.md)
- ./compile.sh

## How to flash for the first time (or recovery)
- connect esp32 using usb (be sure you have right usb-serial drivers installed)
- mos flash

Check mongoose os documentation for more info, such as specifying serial port etc...

### OTA flash
When device was previously flashed with this firmware, you should update firmware remotely, no usb required. Set device ip address in env file then call ./ota.sh. If device isn't connected using ethernet, you should connect to RELAYDUINO_MASTER wifi with default password 123456, then device will be at address 192.168.4.1.

## Configuration

### main
    mos config-set masterboard.id=1
    mos config-set masterboard.slaves=ooooiiii   

Masterboard will operate with id 1, slave boards 0-3 are output boards, slave boards 4-7 are input boards. Warning - double check this when you are lost and board seems not work as expected, maybe you misconfigured the board types (my own experience :D)!

### connectivity

#### ethernet

When using ethernet connection, dhcp client is enabled by default. You can see ip address when using mos console over serial connection. To set static ip address on ethernet, just call

    mos config-set eth.ip="192.168.5.123" eth.netmask="255.255.255.0" eth.gw="192.168.5.1"

To enable dhcp, call

     mos config-set eth.ip="" eth.netmask="" eth.gw=""

#### wifi
TODO

#### wifi ap
There is possibility to connect to board by wifi when ethernet or serial is not available. To turn on wifi, hold 'btn1' button until red led start flashing, then release button. Board will be restarted with AP turned on on wifi network RELAYDUINO_MASTER with default password 1234567890. You should connect to this wifi by laptop and configure masterboard this way. Device address will be 192.168.4.1, so export MOS_PORT=ws://192.168.4.1/rpc and then use mos tool as usual. To turn off AP, hold button again, or use config-set as mentioned below

WARNING!! Change wifi password as soon as possible after connect (8+ chars)

    mos config-set wifi.ap.pass="newPassword"
    
and do not forget to disable wifi ap when done

    mos config-set wifi.ap.enable=false

WARNING!! Wifi password will be set to default after using "reset to default" procedure (holding btn1+reset) or reflashing device !



### Transports
#### UDP
For communication using udp packets (for example with loxone), configure following attributes

    mos config-set masterboard.transport.udp.listenport=6666              # port where listen to commands
    mos config-set masterboard.transport.udp.sendaddress="192.168.1.55"   # loxone address
    mos config-set masterboard.transport.udp.sendport=5556                # loxone virtual input port

Command syntax for output board is:

    om1 b2 r14 1    - set relay 14 on slave board 2 on masterboard 1 to ON
    om1 b2 r14 0    - set relay 14 on slave board 2 on masterboard 1 to OFF

Input events generated by input boards has similar syntax:

    im1 b5 i1 0     - input 1 on slave board 5 on masterboard 1 is LOW
    im1 b5 i1 1     - input 1 on slave board 5 on masterboard 1 is HIGH

TODO - this may change in the future, maybe masterboards will not be identified by id anymore (if udp broadcasting feature will be removed)


## Debugging

    source ./env   ;         # do not forget to edit this file
    mos config-set debug.level=3 debug.udp_log_addr=${THIS_PC_ADDRESS}:7777 ;
    socat -u udp-recv:7777 -

Do not forget to set loglevel to 0 when finished (it has a performance impact)

To manually test udp transport, you should send command from linux desktop by using:

    echo "om1 b1 r2 1" >/dev/udp/MASTERBOARD_IP_ADDRESS/UDP_LISTEN_PORT

For example

    echo "om1 b1 r2 1" >/dev/udp/192.168.1.30/6666

To manually check input board events, you should listen at your PC for input event commands similar as listen for logs:

    mos config-set masterboard.transport.udp.sendaddress="THIS_PC_ADDRESS"
    mos config-set masterboard.transport.udp.sendport=3333
    socat -u udp-recv:3333 -


